
#wget https://github.com/prometheus/prometheus/releases/download/v2.48.1/prometheus-2.48.1.linux-amd64.tar.gz
wget https://github.com/prometheus/prometheus/releases/download/v2.53.3/prometheus-2.53.3.linux-amd64.tar.gz
tar xvzf prometheus-2.53.3.linux-amd64.tar.gz
sudo groupadd --system prometheus
sudo useradd -s /sbin/nologin --system -g prometheus prometheus

cd prometheus*
sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus
mv prometheus /usr/local/bin/
mv promtool /usr/local/bin/
mv console* /etc/prometheus/
sudo mv prometheus.yml /etc/prometheus
sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/promtool
sudo chown prometheus:prometheus /etc/prometheus
sudo chown -R prometheus:prometheus /etc/prometheus/consoles
sudo chown -R prometheus:prometheus /etc/prometheus/console_libraries
sudo chown -R prometheus:prometheus /var/lib/prometheus

sudo semanage fcontext -a -t bin_t '/usr/local/bin/prometheus'
sudo restorecon -Rv /usr/local/bin/prometheus
sudo semanage fcontext -a -t etc_t '/etc/prometheus(/.*)?'
sudo restorecon -Rv /etc/prometheus
sudo semanage fcontext -a -t var_lib_t '/var/lib/prometheus(/.*)?'
sudo restorecon -Rv /var/lib/prometheus
  
cat<<EOF> /etc/prometheus/prometheus.yml
global:
  scrape_interval:     10s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'prometheus-central'
    static_configs:
    - targets: ['10.25.131.103:9090']
EOF

cat<<EOF> /etc/systemd/system/prometheus_server.service
[Unit]
Description=Prometheus Server
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus --config.file=/etc/prometheus/prometheus.yml --web.console.templates=/etc/prometheus/consoles --web.console.libraries=/etc/prometheus/console_libraries --storage.tsdb.path=/var/lib/prometheus/ --web.external-url=http://10.25.131.103:9090/

[Install]
WantedBy=default.target
EOF


openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out prometheus.crt -keyout prometheus.key

cd /monitoring
mkdir certs
openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out prometheus.crt -keyout prometheus.key
vi /etc/prometheus/web-config.yaml

tls_server_config:
  cert_file: /home/cloud/prometheus/monitoring/certs/prometheus.crt
  key_file: /home/cloud/prometheus/monitoring/certs/prometheus.key
